# Configuraci√≥n de Tailscale en Docker con Persistencia

## 1. Crear el Directorio Persistente

En tu Raspberry Pi (o en el host donde corre Docker), crea el directorio para almacenar el estado de Tailscale:

```sh
mkdir -p /portainer/Files/AppData/Config/tailscale
```

Este directorio se usar√° para mantener la configuraci√≥n y el estado de Tailscale, evitando que se pierda al reiniciar el contenedor o la m√°quina.

---

## 2. Ejecutar el Contenedor de Tailscale Usando el Directorio Persistente

Utiliza el siguiente comando para correr el contenedor. Aseg√∫rate de reemplazar `tskey-auth-XXXXXXXXXXXXX` por tu clave de autenticaci√≥n generada desde el panel de administraci√≥n de Tailscale:

```sh
docker run -d --name tailscaled \
  -v /portainer/Files/AppData/Config/tailscale:/var/lib/tailscale \
  -v /dev/net/tun:/dev/net/tun \
  --network=host \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  -e TS_STATE_DIR=/var/lib/tailscale \
  -e TS_AUTHKEY=tskey-auth-XXXXXXXXXXXXX \
  tailscale/tailscale:stable
```

### üìå Detalles Importantes del Comando

- **Persistencia**: `-v /portainer/Files/AppData/Config/tailscale:/var/lib/tailscale`
  - Permite que la informaci√≥n se mantenga entre reinicios.
- **Acceso a TUN**: `-v /dev/net/tun:/dev/net/tun`
  - Permite que el contenedor acceda al dispositivo TUN, necesario para la operaci√≥n de Tailscale.
- **Red y permisos**:
  - Se usa `--network=host` junto con `NET_ADMIN` y `NET_RAW` para la gesti√≥n de red.
- **Variables de Entorno**:
  - `TS_STATE_DIR=/var/lib/tailscale` para definir la ubicaci√≥n del estado.
  - `TS_AUTHKEY` permite la autenticaci√≥n autom√°tica.

---

## 3. Verificar y Ajustar la Configuraci√≥n

### üîç Revisar los logs para asegurarse de que el contenedor se inicie sin errores:

```sh
docker logs tailscaled
```

### üìå Verificar el estado de Tailscale:

```sh
docker exec tailscaled tailscale status
```

Si ves que aparece **‚ÄúLogged out‚Äù** y una URL para iniciar sesi√≥n, puedes forzar la autenticaci√≥n manualmente:

```sh
docker exec tailscaled tailscale up --authkey=tskey-auth-XXXXXXXXXXXXX --reset
```

### üöÄ (Opcional) Configurar como Nodo de Salida:

Si deseas que tu Raspberry Pi act√∫e como **exit node**, ejecuta:

```sh
docker exec tailscaled tailscale up --advertise-exit-node --accept-dns=false --reset
```

üìå El flag `--accept-dns=false` se incluye seg√∫n lo que requiere Tailscale al modificar configuraciones no predeterminadas.

---

## 4. Configurar Reinicio Autom√°tico del Contenedor

Para asegurarte de que el contenedor se reinicie autom√°ticamente despu√©s de un reinicio de la Raspberry Pi, actualiza su pol√≠tica de reinicio:

```sh
docker update --restart unless-stopped tailscaled
```
